-- WindUI rewrite of the Vuzez || Universal script (was Orion)

local player = game.Players.LocalPlayer
local mouse = player:GetMouse()

-- remove anti/afk localscripts the game might inject
do
    local scriptsFolder = player:FindFirstChild("PlayerScripts")
    if scriptsFolder then
        for _, name in ipairs({ "AFK", "Anti", "AE" }) do
            local inst = scriptsFolder:FindFirstChild(name)
            if inst then
                inst:Destroy()
            end
        end
    end
end

-- load WindUI
local WindUI
do
    local ok, result = pcall(function()
        return require("./src/Init")
    end)
    if ok then
        WindUI = result
    else
        WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
    end
end

-- PATCH: Fix WindUI Icons crash (missing .Icons table in 'solar' pack)
if WindUI and WindUI.Creator and WindUI.Creator.Icons and WindUI.Creator.Icons.Icons then
    local solar = WindUI.Creator.Icons.Icons["solar"]
    if solar then
        if not solar.Icons then solar.Icons = {} end
        if not solar.Spritesheets then solar.Spritesheets = {} end
    end
end


-- compatibility: add dummy :Connect on RBXScriptConnection to avoid crashes in third-party modules
do
    local tmp = game:GetService("RunService").Heartbeat:Connect(function() end)
    local mt = getmetatable(tmp)
    tmp:Disconnect()
    if mt and mt.__index then
        local oldIndex = mt.__index
        pcall(function()
            setreadonly(mt, false)
            mt.__index = function(self, key)
                if key == "Connect" or key == "connect" then
                    return function(_, _cb)
                        -- if a script tries to :Connect on a connection, just return the connection itself
                        return self
                    end
                end
                return oldIndex(self, key)
            end
            setreadonly(mt, true)
        end)
    end
end

-- tween safety: coerce NumberSequence properties when goals use plain numbers
local function coerceGoals(instance, goals)
    local fixed = {}
    for prop, value in pairs(goals or {}) do
        local current = instance and instance[prop]
        if typeof(current) == "NumberSequence" and type(value) == "number" then
            fixed[prop] = NumberSequence.new(value)
        else
            fixed[prop] = value
        end
    end
    return fixed
end

do
    local TweenService = game:GetService("TweenService")
    local rawCreate

    local function forceNumberSequences(goals)
        local fixed = {}
        for prop, value in pairs(goals or {}) do
            if type(value) == "number" then
                fixed[prop] = NumberSequence.new(value)
            else
                fixed[prop] = value
            end
        end
        return fixed
    end

    local function createSafe(self, instance, tweenInfo, goals)
        rawCreate = rawCreate or TweenService.Create
        local ok, result = pcall(rawCreate, self, instance, tweenInfo, coerceGoals(instance, goals))
        if ok then
            return result
        end
        local ok2, result2 = pcall(rawCreate, self, instance, tweenInfo, forceNumberSequences(goals))
        if ok2 then
            return result2
        end
        warn("[TweenSafe] suppressed Tween error:", result, result2)
        return {
            Play = function() end,
            Pause = function() end,
            Cancel = function() end,
        }
    end

    -- direct override (covers cached references to the function itself)
    pcall(function()
        rawCreate = rawCreate or TweenService.Create
        TweenService.Create = function(self, instance, tweenInfo, goals)
            return createSafe(self, instance, tweenInfo, goals)
        end
    end)

    -- hookfunction fallback (if available)
    pcall(function()
        rawCreate = rawCreate or TweenService.Create
        rawCreate = hookfunction(rawCreate, function(self, instance, tweenInfo, goals)
            return createSafe(self, instance, tweenInfo, goals)
        end)
    end)

    -- namecall hook (colon syntax)
    pcall(function()
        local old
        old = hookmetamethod(game, "__namecall", function(self, ...)
            local method = (getnamecallmethod and getnamecallmethod()) or ""
            if self == TweenService and method == "Create" then
                local instance, tweenInfo, goals = ...
                return TweenService.Create(self, instance, tweenInfo, goals)
            end
            return old(self, ...)
        end)
    end)

    -- metatable __index fallback
    pcall(function()
        local mt = getrawmetatable(TweenService)
        if not mt then
            return
        end
        local oldIndex = mt.__index
        setreadonly(mt, false)
        mt.__index = function(self, key)
            if key == "Create" then
                return function(_, instance, tweenInfo, goals)
                    return createSafe(self, instance, tweenInfo, goals)
                end
            end
            return oldIndex(self, key)
        end
        setreadonly(mt, true)
    end)
end

-- icons used in tabs/elements
WindUI.Creator.AddIcons("solar", {
    ["CheckSquareBold"] = "rbxassetid://132438947521974",
    ["CursorSquareBold"] = "rbxassetid://120306472146156",
    ["FolderWithFilesBold"] = "rbxassetid://74631950400584",
    ["HamburgerMenuBold"] = "rbxassetid://134384554225463",
    ["Home2Bold"] = "rbxassetid://92190299966310",
    ["SolarSquareTransferHorizontalBold"] = "rbxassetid://125444491429160",
})

local Purple = Color3.fromHex("#7775F2")
local Yellow = Color3.fromHex("#ECA201")
local Green = Color3.fromHex("#10C550")
local Grey = Color3.fromHex("#83889E")
local Blue = Color3.fromHex("#257AF7")
local Red = Color3.fromHex("#EF4F1D")

-- window
local Window = WindUI:CreateWindow({
    Title = "Unstability || Universal",
    Folder = "Unstability",
    IconSize = 44,
    NewElements = true,
    HideSearchBar = false,
    OpenButton = {
        Title = "Open Unstability UI",
        CornerRadius = UDim.new(1, 0),
        StrokeThickness = 3,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false,
        Color = ColorSequence.new(Color3.fromHex("#000000"), Color3.fromHex("#20201f")),
    },
    Topbar = {
        Height = 44,
        ButtonsType = "Mac",
    },
})

-- state
local keepSpeed = false
local targetWalkspeed = 20
local keepJump = false
local targetJump = 50
local godmode = false
local npcKill = false
local noCdLite = false
local tToTP = false
local noCooldownHooked = false

local function notify(title, content)
    WindUI:Notify({
        Title = title,
        Content = content,
    })
end

-- Home tab
local HomeTab = Window:Tab({
    Title = "Home",
    Icon = "solar:Home2Bold",
    IconColor = Grey,
    IconShape = "Square",
})

HomeTab:Section({
    Title = "Script made by error_v5",
    TextSize = 16,
})

HomeTab:Space()

HomeTab:Button({
    Title = "Infinite Yield",
    Icon = "solar:FolderWithFilesBold",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source", true))()
    end,
})

HomeTab:Space()

HomeTab:Button({
    Title = "Self Destruct",
    Color = Red,
    Icon = "solar:CursorSquareBold",
    Callback = function()
        Window:Destroy()
    end,
})

-- Main tab
local MainTab = Window:Tab({
    Title = "Main",
    Icon = "solar:CursorSquareBold",
    IconColor = Blue,
    IconShape = "Square",
})

MainTab:Toggle({
    Title = "NPC Kill",
    Desc = "Kills all humanoids except you",
    Callback = function(value)
        npcKill = value
        task.spawn(function()
            while npcKill do
                task.wait(0.5)
                pcall(function()
                    sethiddenproperty(player, "SimulationRadius", 112412400000)
                    sethiddenproperty(player, "MaxSimulationRadius", 112412400000)
                    for _, inst in ipairs(workspace:GetDescendants()) do
                        if inst.ClassName == "Humanoid" and inst.Parent then
                            local char = inst.Parent
                            if char.Name ~= player.Name then
                                -- guard rigs missing expected parts (avoids VFX errors) and require CDValues folder
                                local hasCoreParts = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Head")
                                local hasLeft = char:FindFirstChild("Aleft") or char:FindFirstChild("Left Arm") or char:FindFirstChild("LeftHand")
                                local hasCD = char:FindFirstChild("CDValues")
                                if hasCoreParts and hasLeft and hasCD then
                                    inst.Health = 0
                                end
                            end
                        end
                    end
                end)
            end
        end)
    end,
})

MainTab:Space()

MainTab:Button({
    Title = "No Cooldown",
    Desc = "Hooks wait() to instant return (unsafe)",
    Icon = "solar:SolarSquareTransferHorizontalBold",
    Callback = function()
        if noCooldownHooked then
            notify("No Cooldown", "Already active")
            return
        end
        local originalWait
        originalWait = hookfunction(wait, function(...)
            return originalWait(0)
        end)
        noCooldownHooked = true
        notify("No Cooldown", "wait() hook applied")
    end,
})

MainTab:Space()

MainTab:Toggle({
    Title = "No Cd Lite",
    Desc = "Sets cooldown values to 0",
    Callback = function(value)
        noCdLite = value
        task.spawn(function()
            while noCdLite do
                task.wait(1)
                for _, v in ipairs(player:GetDescendants()) do
                    if (v:IsA("NumberValue") or v:IsA("IntValue")) and v.Name == "cooldown" then
                        v.Value = 0
                    end
                end
            end
        end)
    end,
})

MainTab:Space()

MainTab:Button({
    Title = "Mini Spam Tool",
    Icon = "solar:HamburgerMenuBold",
    Callback = function()
        local tool = Instance.new("Tool")
        tool.RequiresHandle = false
        tool.Name = "Mini Spam Tool"
        tool.ToolTip = "weaker yet still deadly"
        tool.CanBeDropped = false
        tool.Activated:Connect(function()
            local hit = mouse.Hit + Vector3.new(0, 0, 0)
            for _, descendant in ipairs(game:GetDescendants()) do
                if descendant:IsA("Tool") and descendant:FindFirstChild("RemoteEvent") then
                    if descendant.Name ~= "fc" then
                        descendant.RemoteEvent:FireServer(hit.X, hit.Y, hit.Z)
                    end
                end
            end
        end)
        tool.Parent = player.Backpack
    end,
})

MainTab:Space()

MainTab:Button({
    Title = "Spam Tool",
    Icon = "solar:HamburgerMenuBold",
    Callback = function()
        local tool = Instance.new("Tool")
        tool.RequiresHandle = false
        tool.Name = "Spam Tool"
        tool.ToolTip = "fire a bunch of attacks"
        tool.CanBeDropped = false
        tool.Activated:Connect(function()
            local hit = mouse.Hit + Vector3.new(0, 2.5, 0)
            for _, ev in ipairs(game:GetDescendants()) do
                if ev:IsA("RemoteEvent") and not (ev:IsDescendantOf(game:GetService("CorePackages")) or ev:IsDescendantOf(game:GetService("RobloxReplicatedStorage"))) then
                    ev:FireServer(hit.X, hit.Y, hit.Z)
                end
            end
        end)
        tool.Parent = player.Backpack
    end,
})

MainTab:Space()

MainTab:Toggle({
    Title = "GodMode",
    Desc = "Disables CanTouch while on",
    Callback = function(value)
        godmode = value
        if value then
            task.spawn(function()
                while godmode do
                    for _, part in ipairs(workspace:GetChildren()) do
                        if part.Name == player.Name then
                            for _, child in ipairs(part:GetChildren()) do
                                if child:IsA("BasePart") then
                                    child.CanTouch = false
                                end
                            end
                        end
                    end
                    task.wait()
                end
            end)
        else
            task.delay(1.5, function()
                if player.Character then
                    for _, child in ipairs(player.Character:GetChildren()) do
                        if child:IsA("BasePart") then
                            child.CanTouch = true
                        end
                    end
                end
            end)
        end
    end,
})


MainTab:Space()

-- NPC Dropdown Logic
local npcCache = {}
local npcNames = {}
local npcDropdown = nil

local function refreshNPCs()
    table.clear(npcCache)
    table.clear(npcNames)
    
    local counts = {}
    for _, v in ipairs(workspace:GetDescendants()) do
        if v:IsA("Humanoid") and v.Parent and v.Parent ~= player.Character then
            local char = v.Parent
            local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Head")
            if root then
                local name = char.Name
                -- handle duplicates
                if counts[name] then
                    counts[name] = counts[name] + 1
                    name = name .. " [" .. counts[name] .. "]"
                else
                    counts[name] = 1
                end
                
                npcCache[name] = root
                table.insert(npcNames, name)
            end
        end
    end
    table.sort(npcNames)
    if npcDropdown then
        npcDropdown:Refresh(npcNames)
    end
end

MainTab:Button({
    Title = "Refresh NPC List",
    Icon = "solar:SolarSquareTransferHorizontalBold",
    Callback = refreshNPCs
})

npcDropdown = MainTab:Dropdown({
    Title = "Select NPC to TP",
    Multi = false,
    Required = false,
    Values = {},
    Callback = function(value)
        if type(value) == "table" then value = value[1] end -- handle multi-select return just in case
        if not value then return end
        
        local targetPart = npcCache[value]
        if targetPart then
            player.Character.HumanoidRootPart.CFrame = targetPart.CFrame * CFrame.new(0, 3, 0)
            notify("TP NPC", "Teleported to " .. value)
        else
            notify("TP NPC", "Target not found (refresh list?)")
        end
    end,
})



MainTab:Space()

-- Mob Dropdown Logic (filtered by CDValues)
local mobCache = {}
local mobNames = {}
local mobDropdown = nil

local function refreshMobs()
    table.clear(mobCache)
    table.clear(mobNames)
    
    local counts = {}
    for _, v in ipairs(workspace:GetDescendants()) do
        if v:IsA("Humanoid") and v.Parent and v.Parent ~= player.Character then
            local char = v.Parent
            -- Mob filter: Must have CDValues folder (matches kill script logic)
            if char:FindFirstChild("CDValues") then
                local root = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Head")
                if root then
                    local name = char.Name
                    -- handle duplicates
                    if counts[name] then
                        counts[name] = counts[name] + 1
                        name = name .. " [" .. counts[name] .. "]"
                    else
                        counts[name] = 1
                    end
                    
                    mobCache[name] = root
                    table.insert(mobNames, name)
                end
            end
        end
    end
    table.sort(mobNames)
    if mobDropdown then
        mobDropdown:Refresh(mobNames)
    end
end

MainTab:Button({
    Title = "Refresh Mob List",
    Icon = "solar:SolarSquareTransferHorizontalBold",
    Callback = refreshMobs
})

mobDropdown = MainTab:Dropdown({
    Title = "Select Mob to TP",
    Multi = false,
    Required = false,
    Values = {},
    Callback = function(value)
        if type(value) == "table" then value = value[1] end
        if not value then return end
        
        local targetPart = mobCache[value]
        if targetPart then
            player.Character.HumanoidRootPart.CFrame = targetPart.CFrame * CFrame.new(0, 3, 0)
            notify("TP Mob", "Teleported to " .. value)
        else
            notify("TP Mob", "Mob not found (refresh list?)")
        end
    end,
})

-- Player tab
local PlayerTab = Window:Tab({
    Title = "Player",
    Icon = "solar:CheckSquareBold",
    IconColor = Purple,
    IconShape = "Square",
})

PlayerTab:Slider({
    Title = "Speed",
    Desc = "Walkspeed",
    Color = Red,
    Step = 1,
    Value = {
        Min = 20,
        Max = 700,
        Default = 20,
    },
    Callback = function(value)
        targetWalkspeed = value
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.WalkSpeed = value
        end
    end,
})

PlayerTab:Toggle({
    Title = "Keep Speed",
    Callback = function(value)
        keepSpeed = value
        task.spawn(function()
            while keepSpeed do
                if player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.WalkSpeed ~= targetWalkspeed then
                    player.Character.Humanoid.WalkSpeed = targetWalkspeed
                end
                task.wait()
            end
        end)
    end,
})

PlayerTab:Space()

PlayerTab:Slider({
    Title = "Jumppower",
    Color = Blue,
    Step = 1,
    Value = {
        Min = 50,
        Max = 700,
        Default = 50,
    },
    Callback = function(value)
        targetJump = value
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.JumpPower = value
        end
    end,
})

PlayerTab:Toggle({
    Title = "Keep Jumppower",
    Callback = function(value)
        keepJump = value
        task.spawn(function()
            while keepJump do
                if player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.JumpPower ~= targetJump then
                    player.Character.Humanoid.JumpPower = targetJump
                end
                task.wait()
            end
        end)
    end,
})

PlayerTab:Space()

PlayerTab:Button({
    Title = "TP Tool",
    Icon = "solar:HamburgerMenuBold",
    Callback = function()
        local tpTool = Instance.new("Tool")
        tpTool.RequiresHandle = false
        tpTool.Name = "Click Teleport"
        tpTool.ToolTip = "Teleports you to where you click."
        tpTool.CanBeDropped = false
        tpTool.Activated:Connect(function()
            local pos = mouse.Hit + Vector3.new(0, 3, 0)
            local cf = CFrame.new(pos.X, pos.Y, pos.Z, select(4, player.Character.HumanoidRootPart.CFrame:components()))
            player.Character.HumanoidRootPart.CFrame = cf
            local sound = Instance.new("Sound")
            sound.Name = "tpsfx"
            sound.Volume = 4
            sound.Parent = player.PlayerGui
            sound.SoundId = "rbxassetid://5124453445"
            sound.TimePosition = 0
            sound.Playing = true
            task.wait(1)
            sound:Destroy()
        end)
        tpTool.Parent = player.Backpack
    end,
})

PlayerTab:Toggle({
    Title = "T To TP",
    Callback = function(value)
        tToTP = value
    end,
})

game:GetService("UserInputService").InputBegan:Connect(function(input, processed)
    if processed then
        return
    end
    if input.KeyCode == Enum.KeyCode.T and tToTP then
        local pos = mouse.Hit + Vector3.new(0, 3, 0)
        local cf = CFrame.new(pos.X, pos.Y, pos.Z, select(4, player.Character.HumanoidRootPart.CFrame:components()))
        player.Character.HumanoidRootPart.CFrame = cf
        local sound = Instance.new("Sound")
        sound.Name = "tpsfx"
        sound.Volume = 4
        sound.Parent = player.PlayerGui
        sound.SoundId = "rbxassetid://5124453445"
        sound.TimePosition = 0
        sound.Playing = true
        task.wait(1)
        sound:Destroy()
    end
end)

PlayerTab:Space()

PlayerTab:Button({
    Title = "Hide Username",
    Icon = "solar:CheckSquareBold",
    Callback = function()
        if player.Character then
            for _, inst in ipairs(player.Character:GetDescendants()) do
                if (inst:IsA("TextLabel") or inst:IsA("TextButton")) and inst.Text == player.Name then
                    inst.Text = ""
                end
            end
        end
    end,
})

-- keep CanTouch off while godmode is enabled
task.spawn(function()
    while true do
        if godmode and player.Character then
            for _, part in ipairs(player.Character:GetChildren()) do
                if part:IsA("BasePart") then
                    part.CanTouch = false
                end
            end
        end
        task.wait(1)
    end
end)
